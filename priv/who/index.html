<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Who am I?</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="color-scheme" content="dark light" />
    <link rel="icon" href="https://fav.farm/%F0%9F%A5%B8" />
    <script src="qrcode.js"></script>
    <style>
      :root {
        --bg: #0e1116;
        --card: #161b22;
        --muted: #8b949e;
        --text: #e6edf3;
        --accent: #58a6ff;
        --ok: #2ea043;
        --warn: #d29922;
        --danger: #f85149;
        --border: #30363d;
        --input: #0b0f14;
        --shadow: 0 6px 20px rgba(0, 0, 0, 0.35);
        --radius: 14px;
        --space: clamp(10px, 2.2vw, 16px);
        --tap: 44px; /* min touch target */
      }
      * {
        box-sizing: border-box;
      }
      html,
      body {
        margin: 0;
        height: 100%;
      }
      body {
        font-family:
          ui-sans-serif,
          system-ui,
          -apple-system,
          Segoe UI,
          Roboto,
          Arial,
          sans-serif;
        background: radial-gradient(1200px 800px at 10% 0%, #0c121a 0%, #0e1116 40%, #0e1116 100%);
        color: var(--text);
        line-height: 1.45;
        -webkit-text-size-adjust: 100%;
        text-size-adjust: 100%;
        padding-bottom: calc(70px + env(safe-area-inset-bottom, 0px)); /* keep content above fixed footer */
      }
      a {
        color: var(--accent);
        text-decoration: none;
      }
      header {
        position: sticky;
        top: 0;
        z-index: 3;
        backdrop-filter: blur(10px);
        background: rgba(14, 17, 22, 0.6);
        border-bottom: 1px solid var(--border);
      }
      .bar {
        max-width: 980px;
        margin: 0 auto;
        padding: calc(var(--space) * 0.6) max(16px, var(--space)) calc(var(--space) * 0.6) max(16px, var(--space));
        padding-top: calc(env(safe-area-inset-top, 0px) + var(--space) * 0.4);
        display: flex;
        gap: 10px;
        align-items: center;
        justify-content: space-between;
        flex-wrap: wrap; /* allow wrapping on small screens */
      }
      .title {
        font-weight: 700;
        letter-spacing: 0.2px;
        font-size: clamp(18px, 4vw, 20px);
      }
      .pill {
        font-size: 12px;
        color: var(--muted);
        padding: 2px 8px;
        border: 1px solid var(--border);
        border-radius: 999px;
        white-space: nowrap;
      }
      .wrap {
        max-width: 980px;
        margin: 18px auto 80px;
        padding: 0 max(12px, var(--space));
      }

      .card {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        padding: var(--space);
      }

      h1,
      h2,
      h3 {
        margin: 0 0 10px;
      }
      h1 {
        font-size: clamp(18px, 4.5vw, 22px);
      }
      h2 {
        font-size: clamp(16px, 3.8vw, 18px);
      }
      p {
        color: var(--muted);
        margin: 8px 0 14px;
        font-size: clamp(14px, 3.6vw, 16px);
      }

      .row {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
      }
      .grow {
        flex: 1 1 auto;
      }
      .btn {
        cursor: pointer;
        border: 1px solid var(--border);
        background: linear-gradient(#1b222c, #161b22);
        color: var(--text);
        padding: 10px 12px;
        border-radius: 10px;
        font-weight: 600;
        letter-spacing: 0.2px;
        min-height: var(--tap);
        line-height: 1.1;
      }
      .btn:hover {
        border-color: #3b4450;
      }
      .btn.small {
        padding: 8px 10px;
        font-size: 13px;
        min-height: var(--tap);
      }
      .btn.ghost {
        background: transparent;
      }
      .btn.accent {
        background: linear-gradient(#1580ff, #0e6ae6);
        border-color: #2b78ff;
      }
      .btn.ok {
        background: linear-gradient(#2ea043, #238636);
        border-color: #2ea043;
      }
      .btn.warn {
        background: linear-gradient(#d29922, #b8841c);
        border-color: #d29922;
      }
      .btn.danger {
        background: linear-gradient(#f85149, #da3b32);
        border-color: #f85149;
      }

      input[type="text"] {
        width: 100%;
        padding: 12px;
        border-radius: 10px;
        border: 1px solid var(--border);
        background: var(--input);
        color: var(--text);
        outline: none;
        min-height: var(--tap);
      }
      input[type="text"]::placeholder {
        color: #7b8591;
      }

      .list {
        margin: 8px 0 0;
        display: grid;
        gap: 8px;
      }
      .person {
        display: grid;
        grid-template-columns: 1fr auto auto;
        gap: 8px;
        align-items: center;
        padding: 10px;
        border: 1px solid var(--border);
        border-radius: 12px;
        background: #11161d;
      }
      .badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        font-size: 12px;
        padding: 3px 8px;
        border-radius: 999px;
        border: 1px solid var(--border);
        color: var(--muted);
        white-space: nowrap;
      }
      .badge.ok {
        color: #9fe3af;
        border-color: rgba(46, 160, 67, 0.4);
        background: rgba(46, 160, 67, 0.08);
      }
      .badge.na {
        color: #ffcab2;
        border-color: rgba(210, 153, 34, 0.4);
        background: rgba(210, 153, 34, 0.08);
      }
      .mono {
        font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
        font-size: 12px;
        color: var(--muted);
        word-break: break-all;
      }

      .grid {
        margin-top: 10px;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 10px;
      }
      .tile {
        padding: 12px;
        border: 1px solid var(--border);
        border-radius: 12px;
        background: #0f141b;
        min-height: 84px;
        display: grid;
        align-content: start;
        gap: 8px;
      }
      .name {
        font-weight: 700;
        word-break: break-word;
      }
      .identity {
        color: #cfd7e3;
        word-break: break-word;
      }
      .blurred {
        filter: blur(7px);
        user-select: none;
      }
      .muted {
        color: var(--muted);
      }

      .divider {
        height: 1px;
        background: var(--border);
        margin: 14px 0;
      }

      dialog::backdrop {
        background: rgba(0, 0, 0, 0.6);
      }
      dialog {
        border: 1px solid var(--border);
        border-radius: 14px;
        background: var(--card);
        color: var(--text);
        width: min(560px, calc(100vw - 24px));
        max-width: 100%;
        max-height: calc(100dvh - 24px);
        overflow: auto;
        box-shadow: var(--shadow);
        padding: 0;
      }
      .dlg-head {
        padding: 14px 16px;
        border-bottom: 1px solid var(--border);
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: sticky;
        top: 0;
        background: var(--card);
        z-index: 1;
      }
      .dlg-body {
        padding: 14px 16px;
      }
      .dlg-foot {
        padding: 12px 16px;
        border-top: 1px solid var(--border);
        display: flex;
        justify-content: flex-end;
        gap: 8px;
        position: sticky;
        bottom: 0;
        background: var(--card);
      }
      .qr {
        display: grid;
        place-items: center;
        padding: 12px;
        border: 1px dashed var(--border);
        border-radius: 12px;
        background: #0f141b;
      }
      .qr > #qrBox {
        width: 100%;
        display: grid;
        place-items: center;
      }
      .hint {
        font-size: 12px;
        color: var(--muted);
      }
      .footer {
        position: fixed;
        inset-inline: 0;
        bottom: 0;
        display: grid;
        place-items: center;
        padding: 12px;
        pointer-events: none;
      }
      .footer .inner {
        pointer-events: auto;
        font-size: 12px;
        color: var(--muted);
        background: rgba(22, 27, 34, 0.85);
        border: 1px solid var(--border);
        padding: 6px 10px;
        border-radius: 999px;
        backdrop-filter: blur(6px);
        margin-bottom: env(safe-area-inset-bottom, 0px);
      }
      .sr {
        position: absolute;
        width: 1px;
        height: 1px;
        overflow: hidden;
        clip: rect(0 0 0 0);
        white-space: nowrap;
      }

      /* Focus styles for accessibility */
      :focus-visible {
        outline: 2px solid var(--accent);
        outline-offset: 2px;
        border-radius: 12px;
      }

      /* Spacious, clean reveal mode */
      .reveal-mode .wrap {
        max-width: 1200px;
      }
      .reveal-mode #viewReveal .grid {
        gap: 16px;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      }
      @media (min-width: 1100px) {
        .reveal-mode #viewReveal .grid {
          grid-template-columns: repeat(3, 1fr);
        }
      }
      .reveal-mode #viewReveal .tile {
        padding: 20px;
        min-height: 120px;
        align-content: center;
      }
      .reveal-mode #viewReveal .name {
        font-size: 18px;
      }
      .reveal-mode #viewReveal .identity {
        font-size: 16px;
      }
      .reveal-mode header .bar {
        padding-block: 8px;
      } /* a bit slimmer header in reveal */

      /* ---------- Mobile-specific improvements ---------- */
      @media (max-width: 640px) {
        .person {
          grid-template-columns: 1fr; /* stack name/status/actions */
          gap: 6px;
        }
        .person .row {
          justify-content: flex-start;
          gap: 6px;
        }
        .grid {
          grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
          gap: 8px;
        }
        .bar .row:last-child {
          width: 100%;
          justify-content: flex-start;
          gap: 8px;
        }
        .pill {
          margin-left: 6px;
        }
      }

      @media (hover: none) {
        .btn:hover {
          border-color: var(--border); /* avoid sticky hover on touch */
        }
      }
      @media (prefers-reduced-motion: reduce) {
        * {
          scroll-behavior: auto !important;
          animation-duration: 0.001ms !important;
          animation-iteration-count: 1 !important;
          transition-duration: 0.001ms !important;
        }
      }

      /* iOS tap highlight */
      * {
        -webkit-tap-highlight-color: transparent;
      }
    </style>
  </head>
  <body>
    <header>
      <div class="bar">
        <div class="row">
          <div class="title">Who am I?</div>
          <div id="gameIdBadge" class="pill" title="Game ID"></div>
        </div>
        <div class="row">
          <button id="shareBtn" class="btn small">Share / QR</button>
          <button id="newGameBtn" class="btn small danger">New game</button>
        </div>
      </div>
    </header>

    <div class="wrap">
      <!-- Initial create game -->
      <section id="viewCreate" class="card" style="display: none">
        <h1>Start a new game</h1>
        <p>Enter your name. You’ll be the first participant. Then add others and assign identities.</p>
        <div class="row">
          <input id="creatorName" type="text" placeholder="Your name…" />
          <button id="createGameBtn" class="btn accent">Create game</button>
        </div>
      </section>

      <!-- Add participants / assign identities -->
      <section id="viewLobby" class="card" style="display: none">
        <h1>Participants & identities</h1>
        <p class="mono" id="meInfo"></p>

        <div class="row">
          <input id="addName" type="text" placeholder="Add participant name…" />
          <button id="addBtn" class="btn">Add</button>
        </div>

        <div id="peopleList" class="list"></div>

        <div class="divider"></div>
        <div class="row">
          <button id="viewIdentitiesBtn" class="btn ok">View identities</button>
          <button id="pickSelfBtn" class="btn ghost">I’m not the right person</button>
        </div>
        <p class="hint">
          Tip: Hand the device to the person assigning an identity and use “Set identity”. Identities don’t show here.
        </p>
      </section>

      <!-- Viewer: identities list with my own hidden -->
      <section id="viewReveal" class="card" style="display: none">
        <div class="row" style="justify-content: space-between; align-items: baseline">
          <h1>Everyone’s identity (except yours)</h1>
          <button id="backToLobbyBtn" class="btn ghost small">Back to edit</button>
        </div>
        <p class="mono" id="revealMeInfo"></p>
        <div id="revealGrid" class="grid"></div>
        <div class="divider"></div>
        <div class="row">
          <button id="shareBtn2" class="btn small">Share / QR</button>
          <button id="pickSelfBtn2" class="btn ghost small">I’m not the right person</button>
        </div>
        <p class="hint">
          Share this page so others can pick who they are. Their own identity will stay hidden to them.
        </p>
      </section>
    </div>

    <div class="footer">
      <div class="inner">No server. State lives in the URL. You can refresh safely.</div>
    </div>

    <!-- Dialogs -->
    <dialog id="dlgIdentity">
      <div class="dlg-head">
        <strong>Set identity</strong>
        <button class="btn small ghost" onclick="document.getElementById('dlgIdentity').close()">Close</button>
      </div>
      <div class="dlg-body">
        <div id="whoFor" class="mono" style="margin-bottom: 8px"></div>
        <input id="identityInput" type="text" placeholder="Type the secret identity…" />
      </div>
      <div class="dlg-foot">
        <button class="btn ghost" onclick="document.getElementById('dlgIdentity').close()">Cancel</button>
        <button id="saveIdentityBtn" class="btn ok">Save identity</button>
      </div>
    </dialog>

    <dialog id="dlgPickSelf">
      <div class="dlg-head">
        <strong>Who are you?</strong>
        <button class="btn small ghost" onclick="document.getElementById('dlgPickSelf').close()">Close</button>
      </div>
      <div class="dlg-body">
        <p class="hint">Pick yourself so your identity stays hidden for you.</p>
        <div id="pickSelfList" class="list"></div>
      </div>
    </dialog>

    <dialog id="dlgShare">
      <div class="dlg-head">
        <strong>Share this game</strong>
        <button class="btn small ghost" onclick="document.getElementById('dlgShare').close()">Close</button>
      </div>
      <div class="dlg-body">
        <div class="row">
          <input id="shareLink" type="text" readonly />
          <button id="copyLinkBtn" class="btn">Copy link</button>
        </div>
        <div class="divider"></div>
        <div class="qr">
          <div id="qrBox" aria-label="QR Code"></div>
        </div>
        <p class="hint">Scan to join this exact game state.</p>
      </div>
    </dialog>

    <script>
      // ---------- utilities: base64url encode/decode JSON safely ----------
      const b64u = {
        encode: (strBytes) => btoa(strBytes).replace(/\+/g, "-").replace(/\//g, "_").replace(/=+$/, ""),
        decode: (b64) => {
          b64 = b64.replace(/-/g, "+").replace(/_/g, "/");
          while (b64.length % 4) b64 += "=";
          return atob(b64);
        },
      };
      function encodeJSON(obj) {
        const bytes = new TextEncoder().encode(JSON.stringify(obj));
        let bin = "";
        for (const b of bytes) bin += String.fromCharCode(b);
        return b64u.encode(bin);
      }
      function decodeJSON(b64) {
        const bin = b64u.decode(b64);
        const bytes = new Uint8Array(bin.length);
        for (let i = 0; i < bin.length; i++) bytes[i] = bin.charCodeAt(i);
        return JSON.parse(new TextDecoder().decode(bytes));
      }
      function uid(len = 8) {
        const chars = "abcdefghjkmnpqrstuvwxyz23456789";
        let s = "";
        crypto.getRandomValues(new Uint8Array(len)).forEach((n) => (s += chars[n % chars.length]));
        return s;
      }

      // ---------- URL state handling ----------
      // Hash schema: #s=<b64url-json>&me=<participantId>&view=<reveal|...>
      const SCHEMA_VERSION = 1;
      function readHash() {
        const raw = location.hash.replace(/^#/, "");
        const params = new URLSearchParams(raw);
        const s = params.get("s");
        const me = params.get("me");
        let state = null;
        try {
          state = s ? decodeJSON(s) : null;
        } catch {
          state = null;
        }
        return { state, me };
      }
      function writeHash(state, me, replace = true) {
        // Preserve existing params (e.g., view=reveal) instead of rebuilding from scratch
        const params = new URLSearchParams(location.hash.slice(1));
        if (state) params.set("s", encodeJSON(state));
        else params.delete("s");
        if (me) params.set("me", me);
        else params.delete("me");
        const newHash = "#" + params.toString();
        if (replace) history.replaceState(null, "", newHash);
        else location.hash = newHash;
        render();
      }
      function newEmptyState(creatorName) {
        const id = uid();
        return {
          version: SCHEMA_VERSION,
          gameId: uid(6),
          createdAt: Date.now(),
          participants: [{ id, name: creatorName.trim(), identity: null }],
        };
      }
      function getMe(state, meId) {
        return state?.participants?.find((p) => p.id === meId) || null;
      }

      // ---------- app state (derived from URL only) ----------
      let current = readHash(); // {state, me}

      // ---------- DOM refs ----------
      const el = {
        viewCreate: document.getElementById("viewCreate"),
        viewLobby: document.getElementById("viewLobby"),
        viewReveal: document.getElementById("viewReveal"),
        creatorName: document.getElementById("creatorName"),
        createGameBtn: document.getElementById("createGameBtn"),
        addName: document.getElementById("addName"),
        addBtn: document.getElementById("addBtn"),
        peopleList: document.getElementById("peopleList"),
        viewIdentitiesBtn: document.getElementById("viewIdentitiesBtn"),
        backToLobbyBtn: document.getElementById("backToLobbyBtn"),
        meInfo: document.getElementById("meInfo"),
        revealMeInfo: document.getElementById("revealMeInfo"),
        revealGrid: document.getElementById("revealGrid"),
        pickSelfBtn: document.getElementById("pickSelfBtn"),
        pickSelfBtn2: document.getElementById("pickSelfBtn2"),
        dlgIdentity: document.getElementById("dlgIdentity"),
        whoFor: document.getElementById("whoFor"),
        identityInput: document.getElementById("identityInput"),
        saveIdentityBtn: document.getElementById("saveIdentityBtn"),
        dlgPickSelf: document.getElementById("dlgPickSelf"),
        pickSelfList: document.getElementById("pickSelfList"),
        shareBtn: document.getElementById("shareBtn"),
        shareBtn2: document.getElementById("shareBtn2"),
        dlgShare: document.getElementById("dlgShare"),
        shareLink: document.getElementById("shareLink"),
        copyLinkBtn: document.getElementById("copyLinkBtn"),
        qrCanvas: document.getElementById("qrBox"),
        newGameBtn: document.getElementById("newGameBtn"),
        gameIdBadge: document.getElementById("gameIdBadge"),
      };

      // ---------- rendering ----------
      function render() {
        current = readHash();
        const { state, me } = current;
        const iHaveState = !!state && Array.isArray(state.participants);
        const iAmKnown = iHaveState && !!getMe(state, me);

        // header game id
        el.gameIdBadge.textContent = iHaveState ? `Game ${state.gameId}` : "No game";

        // Reveal mode flag from URL
        const params = new URLSearchParams(location.hash.slice(1));
        const showReveal = params.get("view") === "reveal";

        // Views visibility
        el.viewCreate.style.display = iHaveState ? "none" : "block";
        el.viewLobby.style.display = iHaveState && !showReveal ? "block" : "none";
        el.viewReveal.style.display = iHaveState && showReveal ? "block" : "none";

        // Page layout class for spacious reveal board
        document.body.classList.toggle("reveal-mode", !!(iHaveState && showReveal));

        // If state missing, done.
        if (!iHaveState) return;

        // If on reveal view and user hasn't picked themself yet, prompt
        if (showReveal && !iAmKnown) openPickSelfDialog();

        // Lobby content
        const meObj = getMe(state, me);
        el.meInfo.textContent = meObj ? `You are: ${meObj.name}` : "You are: (choose yourself)";
        renderPeopleList();

        // Reveal content
        el.revealMeInfo.textContent = meObj
          ? `Your identity stays hidden for: ${meObj.name}`
          : "Pick who you are to hide your own identity.";
        renderRevealGrid();
      }

      function renderPeopleList() {
        const { state } = current;
        el.peopleList.innerHTML = "";
        state.participants.forEach((p) => {
          const row = document.createElement("div");
          row.className = "person";

          const left = document.createElement("div");
          left.innerHTML = `<div class="name">${escapeHtml(p.name)}</div>
                            <div class="mono">ID: ${p.id}</div>`;
          const status = document.createElement("div");
          status.innerHTML = p.identity
            ? `<span class="badge ok">assigned</span>`
            : `<span class="badge na">not set</span>`;

          const actions = document.createElement("div");
          actions.className = "row";
          const btnId = document.createElement("button");
          btnId.className = "btn small";
          btnId.textContent = p.identity ? "Edit identity" : "Set identity";
          btnId.addEventListener("click", () => openIdentityDialog(p.id));
          const btnDel = document.createElement("button");
          btnDel.className = "btn small ghost";
          btnDel.textContent = "Remove";
          btnDel.addEventListener("click", () => {
            if (!confirm(`Remove ${p.name}?`)) return;
            state.participants = state.participants.filter((x) => x.id !== p.id);
            // If we removed the viewer, clear me
            let me = current.me;
            if (p.id === me) me = "";
            writeHash(state, me, true);
          });
          actions.append(btnId, btnDel);

          row.append(left, status, actions);
          el.peopleList.appendChild(row);
        });
      }

      function renderRevealGrid() {
        const { state, me } = current;
        el.revealGrid.innerHTML = "";

        const meObj = getMe(state, me);
        const hideAll = !meObj; // hide all identities until user picks themselves

        state.participants.forEach((p) => {
          const tile = document.createElement("div");
          tile.className = "tile";
          tile.style.textAlign = "center";

          const name = document.createElement("div");
          name.className = "name";
          name.textContent = p.name;

          const idy = document.createElement("div");
          idy.className = "identity";

          if (hideAll) {
            idy.textContent = "(pick yourself to reveal others)";
            idy.classList.add("muted", "blurred");
          } else if (p.id === meObj.id) {
            idy.textContent = "Hidden for you";
            idy.classList.add("muted", "blurred");
          } else {
            idy.textContent = p.identity ?? "—";
            if (!p.identity) idy.classList.add("muted");
          }

          tile.append(name, idy);
          el.revealGrid.appendChild(tile);
        });
      }

      // ---------- dialogs & actions ----------
      function openIdentityDialog(pid) {
        const { state } = current;
        const p = state.participants.find((x) => x.id === pid);
        if (!p) return;
        el.whoFor.textContent = `For: ${p.name}`;
        el.identityInput.value = p.identity ?? "";
        el.saveIdentityBtn.onclick = () => {
          const val = el.identityInput.value.trim();
          if (!val) {
            alert("Please enter an identity.");
            return;
          }
          p.identity = val;
          writeHash(state, current.me, true);
          el.dlgIdentity.close();
        };
        el.dlgIdentity.showModal();
        setTimeout(() => el.identityInput.focus(), 10);
      }

      function openPickSelfDialog() {
        const { state } = current;
        el.pickSelfList.innerHTML = "";
        state.participants.forEach((p) => {
          const row = document.createElement("div");
          row.className = "person";
          const label = document.createElement("div");
          label.innerHTML = `<div class="name">${escapeHtml(p.name)}</div><div class="mono">${p.id}</div>`;
          const btn = document.createElement("button");
          btn.className = "btn small ok";
          btn.textContent = "This is me";
          btn.addEventListener("click", () => {
            // Set me and ensure we stay in reveal view
            const params = new URLSearchParams(location.hash.slice(1));
            params.set("me", p.id);
            params.set("view", "reveal");
            location.hash = "#" + params.toString();
            el.dlgPickSelf.close();
          });
          row.append(label, document.createElement("div"), btn);
          el.pickSelfList.appendChild(row);
        });
        if (!el.dlgPickSelf.open) el.dlgPickSelf.showModal();
      }

      // ---------- event wiring ----------
      el.createGameBtn.addEventListener("click", () => {
        const name = (el.creatorName.value || "").trim();
        if (!name) {
          el.creatorName.focus();
          return;
        }
        const state = newEmptyState(name);
        const me = state.participants[0].id;
        writeHash(state, me, false);
      });

      el.addBtn.addEventListener("click", () => {
        const name = (el.addName.value || "").trim();
        if (!name) {
          el.addName.focus();
          return;
        }
        const { state } = current;
        state.participants.push({ id: uid(), name, identity: null });
        el.addName.value = "";
        writeHash(state, current.me, true);
      });

      el.viewIdentitiesBtn.addEventListener("click", () => {
        const params = new URLSearchParams(location.hash.slice(1));
        params.set("view", "reveal");
        location.hash = "#" + params.toString();
      });
      el.backToLobbyBtn.addEventListener("click", () => {
        const params = new URLSearchParams(location.hash.slice(1));
        params.delete("view");
        location.hash = "#" + params.toString();
      });

      el.pickSelfBtn.addEventListener("click", openPickSelfDialog);
      el.pickSelfBtn2.addEventListener("click", openPickSelfDialog);

      function openShare() {
        // Build a link that opens directly on Reveal and doesn't bind "me"
        const params = new URLSearchParams(location.hash.slice(1));
        params.delete("me"); // don't bind identity
        params.set("view", "reveal"); // always open on reveal
        const url = location.origin + location.pathname + location.search + "#" + params.toString();

        el.shareLink.value = url;
        drawQR(url);
        el.dlgShare.showModal();
      }
      el.shareBtn.addEventListener("click", openShare);
      el.shareBtn2.addEventListener("click", openShare);

      el.copyLinkBtn.addEventListener("click", async () => {
        try {
          await navigator.clipboard.writeText(el.shareLink.value);
          el.copyLinkBtn.textContent = "Copied!";
          setTimeout(() => (el.copyLinkBtn.textContent = "Copy link"), 1200);
        } catch {
          prompt("Copy this link:", el.shareLink.value);
        }
      });

      el.newGameBtn.addEventListener("click", () => {
        if (!confirm("Start a new game? This clears the current state.")) return;
        history.replaceState(null, "", location.pathname + location.search);
        render();
      });

      window.addEventListener("hashchange", render);

      /* ===== Responsive QR rendering helper ===== */
      function qrSize() {
        // Keep QR comfortably within dialog body on small screens
        const vw = Math.min(window.innerWidth, 560);
        // subtract some padding to avoid overflow
        const size = Math.max(160, Math.min(360, Math.floor(vw * 0.75)));
        return size;
      }
      function drawQR(text) {
        el.qrCanvas.innerHTML = ""; // clear old
        const size = qrSize();
        new QRCode(el.qrCanvas, {
          text: text,
          width: size,
          height: size,
          correctLevel: QRCode.CorrectLevel.H,
        });
      }
      // Redraw QR on resize if share dialog is open
      let qrRaf = 0;
      window.addEventListener("resize", () => {
        if (!el.dlgShare.open) return;
        cancelAnimationFrame(qrRaf);
        qrRaf = requestAnimationFrame(() => drawQR(el.shareLink.value));
      });

      // ---------- helpers ----------
      function escapeHtml(s) {
        return s.replace(
          /[&<>"']/g,
          (m) => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;" })[m],
        );
      }

      // ---------- boot ----------
      render();
    </script>
  </body>
</html>
